# SIMPLE_CRUD_API

## 설명
간단한 CRUD가 가능한 웹 API 서버이다.

## 주요 사용기술
* express 프레임워크
* mysql
* S3 (이미지 업로드를 위해 사용)
* Route 53 (도메인 이름 등록을 위해 사용)
* EC2 (배포에 사용)
* nginx 리버스 프록시 서버를 이용한 로그 남기기(로컬 환경에서 사용)

## 기능 설명
제목과 같이 CRUD가 가능한 웹 api 서버를 만들었다.

* Create     
  게시물 업로드(사진 포함)를 할 수 있는 기능이다. 업로드된 게시물은 아래와 같이 2가지 유형으로 나뉜다.    
  
    - 사진이 없는 게시물
    - 사진이 있는 게시물
  

* Read  
  게시물을 조회하는 기능이며 전체 게시물 조회, 게시물 상세 조회, 게시물 검색 조회라는 3가지 종류의 조회가 있다.
  

* Update   
  수정의 경우 글 수정과 사진 수정하는 기능이다.
  

* Delete      
  작성된 게시물을 삭제하는 기능이다.
  

## AWS S3(Simple Storage Service)
이번에 사진 업로드 때문에 처음으로 S3를 사용해보았는데 S3에대하여 간단히 정리해보겠다.

* 이점   
  - 높은 내구성을 보장한다.(퍼알아 여러대의 컴퓨터에 저장된다.)       
  - 죽지 않는 파일 서버로 사용할 수 있다.     
  - 파일 삭제나 이동 자동화를 지원한다.       
  - 파일 버전 관리를 할 수 있다.      
    (위에 작성된 기능을 모두 사용하지는 않았다. 단지 위와 같은 이점들이 존재한다고 한다.)
    

* S3 구성 요소
  - Bucket: 프로젝트 당 하나의 버킷이 있다고 생각하면 편하다.
  - 폴더 : Bucket 안에 폴더를 생성할 수 있다.
  - object : 쉽게 말하면 파일이다. 정확히는 파일 + 파일에 대한 부가적인 정보들이라고 생각하면 된다. 

  
* 어떻게 사용했는지     
이미지를 올릴 때 사용하게 되었다. node.js 어플리케이션에서 aws-sdk와 multer-s3 모듈을 사용하여 이미지를 올리고 수정하였다.
  프론트에서 이미지 url을 사용할 수 있도록 퍼블릭 엑세스가 가능하도록 하였다. 업로드는 크게 어렵지 않았지만 기존의 사진을 수정을 
  하는 경우가 문제였다. 원래는 mysql에 저장되어 있는 오브젝트의 key 값을 이용하여 덮어 쓰기를 하려고 하였으나 결과가 반영되지 
  않거나 프론트에서 결과가 바로 반영되지 않고 리프레시를 해줘야하는 문제가 지속적으로 발생하였다. 따라서 아래와 같은 방법으로 수정해야만
  했다.
  
  ```
  (기존 사진 변경)
  변경된 사진 S3 업로드 -> 기존 S3에 업로드된 이미지 제거 -> 반환된 object key 값과 url을 mysql에 update
  ```
  
  기존 문제는 위의 방식으로 해결되었지만 프론트에서 서버로 요청을 보낼 때 보내야하는 데이터가 상황에 따라 복잡해지게 된다는 문제가 발생하였다.
  
  ```
  (수정시 기존 사진 변경) : (imageUrl && file) || (!imageUrl && file, mysql에서 게시물의 사진 있는지 확인) 
  (수정시 사진 업로드) : !imageUrl && file
  (수정시 기존 사진 삭제) : !imageUrl && !file
  ```

  *지금 문서를 작성하면서 느낀건데 (수정시 기존 사진 변경)에서 (!imageUrl && file)은 정말 잘못 생각하고 만든것 같다.

## AWS Route 53
Route 53는 freenom에서 받은 도메인 이름을 적용하기 위해서 사용하게되었다. 여기에 간단히 도메인 이름을 어떻게 적용하는지 작성하겠다.


1. freenom에서 도메인 네임 받기

2. 받은 도메인 네임을 적용하기 위해 AWS Route 53를 이용한다
    * 호스팅 영역 생성: 구매한 도메인 이름 입력
    * 레코드 생성: 값에 EC2 인스턴스 IP 입력
  
3. freenom에서 네임서버 등록    
   호스팅 영역을 생성하면 NS와 SOA라는 2가지 목록이 생긴다. 이 중 NS에 있는 4개의 값을 freenom의 네임서버에 등록한다.

## EC2
api 서버를 배포하는데 사용하였다.

*오랜 시간 띄어 놓지는 않을것 같다. 곧 인스턴스를 제거할 예정이다.

## nginx
웹서버의 일종으로 이번에는 로컬에서 리버스 프록시 서버로 사용하여 로그(access & error)를 남기는 기능을 이용하였다. 
로그를 남기는 파일을 지정할 때는 절대 경로를 이용하로독 하자.
